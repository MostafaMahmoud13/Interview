<script>
  const form = document.getElementById('affiliateForm');
  const phoneCode = document.getElementById('phoneCode');
  const countrySelect = document.getElementById('country');
  const submitBtn = document.getElementById('submitBtn');

  const inputs = {
    firstName: document.getElementById('firstName'),
    lastName: document.getElementById('lastName'),
    email: document.getElementById('email'),
    country: document.getElementById('country'),
    whatsapp: document.getElementById('whatsapp'),
    idImage: document.getElementById('idImage')
  };

  const errors = {
    firstName: document.getElementById('errorFirstName'),
    lastName: document.getElementById('errorLastName'),
    email: document.getElementById('errorEmail'),
    country: document.getElementById('errorCountry'),
    whatsapp: document.getElementById('errorWhatsapp'),
    idImage: document.getElementById('errorIdImage')
  };

  function validateForm() {
    let valid = true;
    for (let key in inputs) {
      const input = inputs[key];
      const error = errors[key];
      if ((input.type === 'file' && input.files.length === 0) ||
          (input.type !== 'file' && input.value.trim() === '')) {
        error.style.display = 'block';
        valid = false;
      } else {
        error.style.display = 'none';
      }
    }
    submitBtn.disabled = !valid;
  }

  // تشغيل التحقق عند الكتابة
  form.addEventListener('input', validateForm);

  // تغيير كود الدولة تلقائي
  countrySelect.addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    const code = selectedOption.getAttribute('data-code');
    phoneCode.value = code || '';
  });

  // تنفيذ الإرسال
  form.addEventListener("submit", function (e) {
    e.preventDefault();
    validateForm(); // نتحقق تاني

    if (submitBtn.disabled) return;

    const data = {
      firstName: inputs.firstName.value.trim(),
      lastName: inputs.lastName.value.trim(),
      email: inputs.email.value.trim(),
      country: inputs.country.value,
      whatsapp: `${phoneCode.value} ${inputs.whatsapp.value.trim()}`,
      idImage: "تم الرفع يدويًا"
    };

    fetch("https://script.google.com/macros/s/AKfycbwdGIgtvakoiK9Z_olABBffWCc_g0IMrtQZesBDQwe2gd9FAyqFr0MSwhSRh8gqlX6zlw/exec", {
      method: "POST",
      body: JSON.stringify(data),
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then((res) => {
      if (res.ok) {
        // مهلة بسيطة ثم تحويل
        setTimeout(() => {
          window.location.href = "thankyou.html";
        }, 200);
      } else {
        alert("حدث خطأ أثناء الإرسال. حاول مرة أخرى.");
      }
    })
    .catch(() => {
      alert("تعذر الاتصال بالسيرفر. تأكد من الاتصال بالإنترنت.");
    });
  });
</script>
